#!/usr/bin/env python

import uuid, sys, os
import ConfigParser
sys.path.append(os.path.dirname(os.getcwd()))
from pssolib.types import *
from pssolib.utils import *
import uuid, sys, time, timeit
from multiprocessing import Process
import zklock

if len(sys.argv) != 7:
    print "Usage: {0} <P|Z> <host1:port1>,<host2:port2>,...  <spinlockid> <#it> <in_nap> <out_nap>".format(sys.argv[0])
    sys.exit(1)


it=int(sys.argv[4])
in_nap=int(sys.argv[5])
out_nap=int(sys.argv[6])
    
#PSSOLib stuff

def spin_pssolib_measure(it):
    print "PID:"+str(get_thread_ident())+"\t"+str(timeit.timeit(spin_pssolib_access,number=it)/it*1000)

def spin_pssolib_access():
    spin.lock()
    time.sleep(in_nap*0.001)
    spin.unlock()
    time.sleep(out_nap*0.001)

# ZK stuff

def spin_zk_measure(it):
    print "PID:"+str(get_thread_ident())+"\t"+str(timeit.timeit(spin_zk_access,number=it)/it*1000)

def spin_zk_access():
    z.acquire()
    time.sleep(in_nap*0.001)
    z.release()
    time.sleep(out_nap*0.001)

# Configuration & Evaluation

if sys.argv[1]=="P":
    parser = ConfigParser.ConfigParser()
    parser.add_section("main")
    parser.set("main","servers",sys.argv[2])
    parser.set("main","keyspace","spinlock")
    cfg = Config.create(parser,False)
    id1=uuid.UUID(sys.argv[3])
    spin = Spinlock(id1)
    spin_pssolib_measure(it)
else:
    zklock.connect(sys.argv[2]+":2181")
    z = zklock.Lock(sys.argv[3])
    spin_zk_measure(it)

# Closing stdout/err

try:
    sys.stdout.close()
except:
    pass
try:
    sys.stderr.close()
except:
    pass
